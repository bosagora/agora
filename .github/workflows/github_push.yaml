# Github worflow to test Agora on a variety of platforms
#
# The CI triggers on 'push' to upstream.
#
# Note:
# - Try to use the native Github action syntax (${{ expression }}) when possible,
#   as they are substituted with their value in the logs, unlike env variable.
#   For example use `${{ github.workspace }}` over `${GITHUB_WORKSPACE}`
name: CD pipeline

on:
  push:
    branches:
      - v*.x.x
      - v*.*.x
      # Use this branch name in your fork to test changes
      - github-actions

jobs:
  main:
    name: Run
    # The configuration matrix: We define all possible combinations here,
    # then add excludes for things we don't want to test,
    # and include to specify job-specific data.
    strategy:
      # Disable `fail-fast` because we want the whole test suite to run even if one
      # of the nigthly is broken
      fail-fast: false
      matrix:
        os: [ ubuntu-18.04, macOS-10.15, windows-2019 ]
        dc: [ dmd-master, ldc-master, dmd-latest ]
        exclude:
          # Not supported yet
          - os: windows-2019
          # We only build documentation on Linux
          # Just use the latest release of DMD here, don't pin the version
          - { os: macOS-10.15,  dc: dmd-latest }
          - { os: windows-2019, dc: dmd-latest }

    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:

    # Checkout this repository and its submodules
    - uses: actions/checkout@v2
      with:
        submodules: true

    # Install the D compiler
    - name: Prepare compiler
      uses: mihails-strasuns/setup-dlang@v0.5.0
      with:
          compiler: ${{ matrix.dc }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}

    # Install os-specific packages
    # Those will show up in the list of steps, but be grayed out,
    # hence the usage of the `[OSX]` tag
    - name: '[OSX] Install dependencies & setup environment'
      if: runner.os == 'macOS'
      run: |
        brew install pkg-config
        ./ci/ci_osx_setup.sh
        echo ::set-env name=LIBRARY_PATH::${LD_LIBRARY_PATH-}:/usr/local/lib/
        echo ::set-env name=PKG_CONFIG_PATH::/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/openssl@1.1/lib/pkgconfig/

    - name: '[Linux] Install dependencies & setup environment'
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install libsqlite3-dev
        sudo apt-get install libsodium-dev
        sudo apt-get install g++-9

    # Add whatever debugging information can be useful in the long run here
    - name: Print system informations
      run: |
        ${DC} --version
        dub --version

    # Build and run the tests
    - name: Build & test Agora
      run: ./ci/run.sh

    # Documentation: Note that this will push documentation to your fork, too!
    - name: Build and deploy documentation
      if: matrix.dc == 'dmd-latest'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        dub build -b ddox
        # Filter out libraries
        # `x:ddocFilterArgs` in `dub.json` does not seem to work,
        # so we do it manually
        jq '[ .[] | select(.file|startswith("source/")) ]' docs.json > docs.filtered.json
        # Generate the HTML to docs
        dub run ddox -- generate-html docs.filtered.json ./docs/
        # Remove gh-branch if it already exists, check it out
        git branch -D gh-pages || true
        git checkout --orphan gh-pages
        # Remove all staged files - We only need the docs
        git rm -rf $(git ls-files)
        # We can have some leftover files (e.g. build)
        # So add docs (which is only what we need), then `git mv` it.
        git add docs/
        git mv -k docs/* ./
        # Configure user (because persist-credentials does not persist everything...)
        git config --global user.name  "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        # We're done
        git commit -m "Documentation for commit ${{ github.sha }}"
        git push -f ${{ github.event.repository.clone_url }} gh-pages:gh-pages
